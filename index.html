<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Championnat Tennis de Table</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        /* ONGLETS */
        .tabs-container {
            background: #f8f9fa;
            border-bottom: 2px solid #ecf0f1;
            padding: 0 30px;
            overflow-x: auto;
        }
        
        .tabs {
            display: flex;
            align-items: center;
            min-width: max-content;
            gap: 5px;
        }
        
        .tab {
            background: #ecf0f1;
            color: #7f8c8d;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
        }
        
        .tab.active {
            background: white;
            color: #2c3e50;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        
        .tab:hover:not(.active) {
            background: #d5dbdb;
            color: #34495e;
        }
        
        .tab.general-ranking {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            font-weight: 600;
        }
        
        .tab.general-ranking.active {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            transform: scale(1.02);
        }
        
        .add-day-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 40px;
            height: 40px;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        
        .add-day-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(39, 174, 96, 0.4);
        }
        
        .remove-day {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #e74c3c;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }
        
        .tab:hover .remove-day {
            display: block;
        }
        
        .content {
            padding: 30px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section {
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border-left: 5px solid #3498db;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        input, select, button, textarea {
            padding: 12px 18px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .import-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin: 25px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 2px dashed #3498db;
        }
        
        .import-box {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .import-box h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            display: block;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
        }
        
        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .guide-box {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #d5f4e6, #a8e6cf);
            border-radius: 12px;
            border-left: 5px solid #27ae60;
        }
        
        .guide-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .guide-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }
        
        .guide-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .key {
            background: #34495e;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
            min-width: 50px;
            text-align: center;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 2px solid #ecf0f1;
        }
        
        .control-buttons .btn {
            padding: 15px 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .divisions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .division {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-top: 4px solid;
        }
        
        .division-1 { border-top-color: #e74c3c; }
        .division-2 { border-top-color: #f39c12; }
        .division-3 { border-top-color: #27ae60; }
        
        .division h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        .players-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            min-height: 60px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .player-tag {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .player-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }
        
        .remove-player {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .matches-container {
            margin-top: 20px;
        }
        
        .tour-section {
            margin-bottom: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .tour-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tour-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 73, 94, 0.4);
        }
        
        .tour-title {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .tour-progress {
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 15px;
        }
        
        .tour-matches {
            display: none;
            animation: slideDown 0.3s ease-out;
        }
        
        .tour-matches.active {
            display: block;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .match {
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .match.completed {
            background: #d5f4e6;
            border-color: #27ae60;
        }
        
        .match:hover {
            border-color: #3498db;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.2);
        }
        
        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .player-names {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .match-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background: #ffeaa7;
            color: #d63031;
        }
        
        .status-completed {
            background: #a8e6cf;
            color: #00b894;
        }
        
        .sets-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .set {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }
        
        .set-disabled {
            opacity: 0.5;
            background: #f0f0f0;
        }
        
        .set-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .set-scores {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        
        .score-input {
            width: 50px;
            height: 40px;
            text-align: center;
            padding: 8px;
            font-weight: bold;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .score-input::-webkit-outer-spin-button,
        .score-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .score-input[type="number"] {
            -moz-appearance: textfield;
        }
        
        .score-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            outline: none;
            background: #f8f9fa;
            transform: scale(1.05);
        }
        
        .set-disabled .score-input {
            background: #f0f0f0;
            color: #999;
            cursor: not-allowed;
            border-color: #ccc;
        }
        
        .score-separator {
            font-weight: bold;
            color: #7f8c8d;
            font-size: 18px;
        }
        
        .match-result {
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            padding: 8px;
            border-radius: 6px;
        }
        
        .result-pending {
            background: #ffeaa7;
            color: #d63031;
        }
        
        .result-completed {
            background: #a8e6cf;
            color: #00b894;
        }
        
        .rankings-section {
            margin-top: 30px;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .rankings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .rankings-title {
            font-size: 1.5rem;
            color: #2c3e50;
            font-weight: bold;
        }
        
        .rankings-toggle {
            display: flex;
            gap: 10px;
        }
        
        .toggle-btn {
            padding: 8px 16px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .toggle-btn.active {
            background: #3498db;
            color: white;
        }
        
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .ranking-table th,
        .ranking-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .ranking-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .ranking-table tr:hover {
            background: #f8f9fa;
        }
        
        .rank-position {
            font-weight: bold;
            color: #3498db;
            width: 50px;
        }
        
        .rank-gold { color: #f39c12; }
        .rank-silver { color: #95a5a6; }
        .rank-bronze { color: #e67e22; }
        
        .stat-value {
            font-weight: bold;
            color: #2c3e50;
        }
        
        /* CLASSEMENT GÉNÉRAL */
        .general-ranking-section {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #f39c12;
        }
        
        .general-ranking-section h2 {
            color: #e67e22;
        }
        
        .general-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .general-stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border-left: 4px solid #f39c12;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .general-stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #f39c12;
            margin-bottom: 5px;
        }
        
        .general-stat-label {
            color: #7f8c8d;
            font-weight: 500;
        }
        
        .player-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1001;
            overflow-y: auto;
        }
        
        .player-modal-content {
            position: relative;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
        }
        
        .player-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .player-name-title {
            font-size: 1.8rem;
            color: #2c3e50;
            font-weight: bold;
        }
        
        .close-modal {
            background: #e74c3c;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }
        
        .player-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .overview-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #3498db;
        }
        
        .overview-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }
        
        .overview-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .matches-history {
            margin-top: 25px;
        }
        
        .history-match {
            background: white;
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-match.win {
            border-left: 4px solid #27ae60;
            background: #d5f4e6;
        }
        
        .history-match.loss {
            border-left: 4px solid #e74c3c;
            background: #ffeaa7;
        }
        
        .history-opponent {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .history-score {
            font-weight: bold;
        }
        
        .stats {
            margin-top: 30px;
            background: #2c3e50;
            color: white;
            padding: 25px;
            border-radius: 12px;
        }
        
        .stats h3 {
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .empty-state {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 30px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
        }
        
        .modal h3 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .modal-buttons {
            margin-top: 20px;
            text-align: right;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            animation: slideInRight 0.3s ease-out;
        }
        
        .notification.success {
            background: #27ae60;
        }
        
        .notification.info {
            background: #3498db;
        }
        
        .notification.warning {
            background: #f39c12;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .divisions {
                grid-template-columns: 1fr;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .import-section {
                grid-template-columns: 1fr;
            }
            
            .sets-container {
                grid-template-columns: 1fr;
            }
            
            .control-buttons {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                padding-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏆 Championnat Tennis de Table</h1>
            <p>Gestion complète multi-journées avec classement général</p>
        </div>
        
        <!-- ONGLETS -->
        <div class="tabs-container">
            <div class="tabs" id="tabs">
                <button class="tab active" onclick="switchTab(1)" data-day="1">
                    Journée 1
                    <button class="remove-day" onclick="event.stopPropagation(); removeDay(1)" title="Supprimer">×</button>
                </button>
                <button class="add-day-btn" onclick="addNewDay()" title="Ajouter une journée">+</button>
                <button class="tab general-ranking" onclick="switchToGeneralRanking()" data-tab="general">
                    🏆 Classement Général
                </button>
            </div>
        </div>
        
        <div class="content">
            <!-- CONTENU JOURNÉE -->
            <div class="tab-content day-content active" id="day-1">
                <div class="section">
                    <h2>👥 Gestion des Joueurs - Journée 1</h2>
                    
                    <div class="input-group">
                        <input type="text" id="playerName" placeholder="Nom du joueur" style="flex: 1; min-width: 200px;">
                        <select id="playerDivision">
                            <option value="1">Division 1</option>
                            <option value="2">Division 2</option>
                            <option value="3">Division 3</option>
                        </select>
                        <button class="btn btn-success" onclick="addPlayer()">Ajouter Joueur</button>
                    </div>
                    
                    <div class="import-section">
                        <div class="import-box">
                            <h4>📁 Import fichier Excel/CSV</h4>
                            <p style="font-size: 14px; color: #7f8c8d; margin-bottom: 15px;">
                                Format : Colonne A = Noms, Colonne B = Division (1,2,3)
                            </p>
                            <div class="file-input-wrapper">
                                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                                <label for="fileInput" class="file-input-label">
                                    📎 Choisir un fichier
                                </label>
                            </div>
                        </div>
                        
                        <div class="import-box">
                            <h4>📋 Copier-coller par division</h4>
                            <p style="font-size: 14px; color: #7f8c8d; margin-bottom: 15px;">
                                Collez une liste de noms (un par ligne)
                            </p>
                            <div style="display: flex; gap: 10px; flex-direction: column;">
                                <select id="bulkDivision" style="width: 100%;">
                                    <option value="1">Division 1</option>
                                    <option value="2">Division 2</option>
                                    <option value="3">Division 3</option>
                                </select>
                                <button class="btn" onclick="showBulkInput()" style="width: 100%;">
                                    📝 Ajouter en masse
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="generateMatches()" style="font-size: 18px; padding: 15px 25px; display: block; margin: 20px auto;">
                        🎯 Générer les Matchs (Round-Robin)
                    </button>
                    
                    <div class="guide-box">
                        <div class="guide-title">
                            💡 Guide d'utilisation
                        </div>
                        <div class="guide-items">
                            <div class="guide-item">
                                <div class="key">TAB</div>
                                <span>Passer au champ suivant</span>
                            </div>
                            <div class="guide-item">
                                <div class="key">ENTER</div>
                                <span>Mettre à jour le match</span>
                            </div>
                            <div class="guide-item">
                                <span>🏆 Le match se termine dès qu'un joueur gagne 2 sets</span>
                            </div>
                            <div class="guide-item">
                                <span>💾 Sauvegarde automatique</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="btn btn-success" onclick="updateRankings()">
                            🏆 Classements
                        </button>
                        <button class="btn" onclick="exportChampionship()">
                            💾 Exporter JSON
                        </button>
                        <button class="btn" onclick="showImportModal()">
                            📁 Importer JSON
                        </button>
                        <button class="btn btn-danger" onclick="clearAllData()">
                            🗑️ Réinitialiser
                        </button>
                    </div>
                </div>
                
                <div class="divisions" id="divisions-1">
                    <!-- Les divisions seront générées dynamiquement -->
                </div>
                
                <div class="rankings-section" id="rankings-1" style="display: none;">
                    <div class="rankings-header">
                        <div class="rankings-title">🏆 Classements Journée 1</div>
                        <div class="rankings-toggle">
                            <button class="toggle-btn active" onclick="showRankings('points')">Par Points</button>
                            <button class="toggle-btn" onclick="showRankings('winrate')">Par % Victoires</button>
                        </div>
                    </div>
                    <div id="rankingsContent-1"></div>
                </div>
                
                <div class="stats" id="stats-1" style="display: none;">
                    <h3>📊 Statistiques Journée 1</h3>
                    <div class="stats-grid" id="statsContent-1"></div>
                </div>
            </div>
            
            <!-- CLASSEMENT GÉNÉRAL -->
            <div class="tab-content general-content" id="general-ranking">
                <div class="section general-ranking-section">
                    <h2>🏆 Classement Général du Championnat</h2>
                    
                    <div class="general-stats" id="generalStats">
                        <!-- Stats générales seront générées ici -->
                    </div>
                    
                    <div class="control-buttons" style="margin-bottom: 30px;">
                        <button class="btn btn-warning" onclick="updateGeneralRanking()">
                            🔄 Mettre à jour Classement Général
                        </button>
                        <button class="btn btn-success" onclick="exportGeneralRanking()">
                            📊 Exporter Classement
                        </button>
                    </div>
                    
                    <div id="generalRankingContent">
                        <div class="empty-state">
                            Terminez au moins un match dans une journée pour voir le classement général
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <h3>Importer un Championnat</h3>
            <div style="margin-bottom: 20px;">
                <div class="file-input-wrapper">
                    <input type="file" id="importFileInput" accept=".json">
                    <label for="importFileInput" class="file-input-label">
                        📁 Choisir un fichier JSON
                    </label>
                </div>
            </div>
            <p style="margin: 15px 0; color: #7f8c8d; font-size: 14px;">
                ⚠️ L'import remplacera complètement le championnat actuel
            </p>
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="closeImportModal()">Annuler</button>
                <button class="btn btn-success" onclick="processImport()">Importer</button>
            </div>
        </div>
    </div>

    <div id="bulkModal" class="modal">
        <div class="modal-content">
            <h3>Ajouter plusieurs joueurs</h3>
            <p style="margin-bottom: 15px; color: #7f8c8d;">
                Collez la liste des noms (un par ligne) pour la <strong id="selectedDivision">Division 1</strong> :
            </p>
            <textarea id="bulkText" placeholder="Joueur 1&#10;Joueur 2&#10;Joueur 3&#10;..." 
                      style="width: 100%; height: 200px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="closeBulkModal()">Annuler</button>
                <button class="btn btn-success" onclick="addBulkPlayers()">Ajouter tous</button>
            </div>
        </div>
    </div>

    <div id="playerModal" class="player-modal">
        <div class="player-modal-content">
            <div class="player-modal-header">
                <div class="player-name-title" id="playerNameTitle"></div>
                <button class="close-modal" onclick="closePlayerModal()">×</button>
            </div>
            <div class="player-overview" id="playerOverview"></div>
            <div class="matches-history">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">📋 Historique des matchs</h3>
                <div id="playerMatches"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // STRUCTURE DE DONNÉES CHAMPIONNAT
        let championship = {
            currentDay: 1,
            days: {
                1: {
                    players: { 1: [], 2: [], 3: [] },
                    matches: { 1: [], 2: [], 3: [] }
                }
            }
        };

        let importedChampionshipData = null;

        // INITIALISATION
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadFromLocalStorage();
            initializeDivisionsDisplay();
            updateTabsDisplay();
        });

        function setupEventListeners() {
            document.getElementById('fileInput').addEventListener('change', handleFileImport);
            document.getElementById('importFileInput').addEventListener('change', handleChampionshipImport);
            
            ['bulkModal', 'importModal'].forEach(modalId => {
                document.getElementById(modalId).addEventListener('click', function(event) {
                    if (event.target === this) {
                        this.style.display = 'none';
                    }
                });
            });
            
            document.getElementById('playerModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closePlayerModal();
                }
            });
            
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeBulkModal();
                    closePlayerModal();
                    closeImportModal();
                }
            });
            
            document.getElementById('playerName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addPlayer();
                }
            });
        }

        // GESTION DES ONGLETS ET JOURNÉES
        function addNewDay() {
            const existingDays = Object.keys(championship.days).map(Number);
            const newDayNumber = Math.max(...existingDays) + 1;
            
            championship.days[newDayNumber] = {
                players: { 1: [], 2: [], 3: [] },
                matches: { 1: [], 2: [], 3: [] }
            };
            
            createDayTab(newDayNumber);
            createDayContent(newDayNumber);
            switchTab(newDayNumber);
            saveToLocalStorage();
            
            showNotification(`Journée ${newDayNumber} créée !`, 'success');
        }

        function createDayTab(dayNumber) {
            const tabsContainer = document.getElementById('tabs');
            const addButton = tabsContainer.querySelector('.add-day-btn');
            
            const newTab = document.createElement('button');
            newTab.className = 'tab';
            newTab.onclick = () => switchTab(dayNumber);
            newTab.dataset.day = dayNumber;
            newTab.innerHTML = `
                Journée ${dayNumber}
                <button class="remove-day" onclick="event.stopPropagation(); removeDay(${dayNumber})" title="Supprimer">×</button>
            `;
            
            tabsContainer.insertBefore(newTab, addButton);
        }

        function createDayContent(dayNumber) {
            const content = document.querySelector('.content');
            const generalRanking = document.getElementById('general-ranking');
            
            const dayContent = document.createElement('div');
            dayContent.className = 'tab-content day-content';
            dayContent.id = `day-${dayNumber}`;
            dayContent.innerHTML = generateDayContentHTML(dayNumber);
            
            content.insertBefore(dayContent, generalRanking);
            initializeDivisionsDisplay(dayNumber);
        }

        function generateDayContentHTML(dayNumber) {
            return `
                <div class="section">
                    <h2>👥 Gestion des Joueurs - Journée ${dayNumber}</h2>
                    
                    <div class="input-group">
                        <input type="text" id="playerName-${dayNumber}" placeholder="Nom du joueur" style="flex: 1; min-width: 200px;">
                        <select id="playerDivision-${dayNumber}">
                            <option value="1">Division 1</option>
                            <option value="2">Division 2</option>
                            <option value="3">Division 3</option>
                        </select>
                        <button class="btn btn-success" onclick="addPlayerToDay(${dayNumber})">Ajouter Joueur</button>
                    </div>
                    
                    <button class="btn" onclick="generateMatchesForDay(${dayNumber})" style="font-size: 18px; padding: 15px 25px; display: block; margin: 20px auto;">
                        🎯 Générer les Matchs (Round-Robin)
                    </button>
                    
                    <div class="control-buttons">
                        <button class="btn btn-success" onclick="updateRankingsForDay(${dayNumber})">
                            🏆 Classements
                        </button>
                    </div>
                </div>
                
                <div class="divisions" id="divisions-${dayNumber}">
                    <!-- Les divisions seront générées dynamiquement -->
                </div>
                
                <div class="rankings-section" id="rankings-${dayNumber}" style="display: none;">
                    <div class="rankings-header">
                        <div class="rankings-title">🏆 Classements Journée ${dayNumber}</div>
                        <div class="rankings-toggle">
                            <button class="toggle-btn active" onclick="showRankingsForDay(${dayNumber}, 'points')">Par Points</button>
                            <button class="toggle-btn" onclick="showRankingsForDay(${dayNumber}, 'winrate')">Par % Victoires</button>
                        </div>
                    </div>
                    <div id="rankingsContent-${dayNumber}"></div>
                </div>
                
                <div class="stats" id="stats-${dayNumber}" style="display: none;">
                    <h3>📊 Statistiques Journée ${dayNumber}</h3>
                    <div class="stats-grid" id="statsContent-${dayNumber}"></div>
                </div>
            `;
        }

        function removeDay(dayNumber) {
            if (Object.keys(championship.days).length <= 1) {
                alert('Vous ne pouvez pas supprimer la dernière journée !');
                return;
            }
            
            if (confirm(`Supprimer définitivement la Journée ${dayNumber} ?\n\nTous les joueurs, matchs et scores seront perdus !`)) {
                delete championship.days[dayNumber];
                
                // Supprimer l'onglet
                document.querySelector(`[data-day="${dayNumber}"]`).remove();
                
                // Supprimer le contenu
                const dayContent = document.getElementById(`day-${dayNumber}`);
                if (dayContent) {
                    dayContent.remove();
                }
                
                // Passer à la première journée disponible
                const remainingDays = Object.keys(championship.days).map(Number);
                switchTab(Math.min(...remainingDays));
                
                saveToLocalStorage();
                showNotification(`Journée ${dayNumber} supprimée`, 'warning');
            }
        }

        function switchTab(dayNumber) {
            championship.currentDay = dayNumber;
            
            // Masquer tous les contenus
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Désactiver tous les onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activer l'onglet et contenu sélectionné
            document.querySelector(`[data-day="${dayNumber}"]`).classList.add('active');
            document.getElementById(`day-${dayNumber}`).classList.add('active');
        }

        function switchToGeneralRanking() {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector('[data-tab="general"]').classList.add('active');
            document.getElementById('general-ranking').classList.add('active');
            
            updateGeneralRanking();
        }

        function updateTabsDisplay() {
            const tabsContainer = document.getElementById('tabs');
            const existingTabs = tabsContainer.querySelectorAll('.tab:not(.general-ranking)');
            
            // Supprimer tous les onglets de journée existants
            existingTabs.forEach(tab => {
                if (!tab.classList.contains('add-day-btn')) {
                    tab.remove();
                }
            });
            
            // Recréer les onglets pour chaque journée
            const addButton = tabsContainer.querySelector('.add-day-btn');
            const generalTab = tabsContainer.querySelector('.general-ranking');
            
            Object.keys(championship.days).sort((a, b) => Number(a) - Number(b)).forEach(dayNumber => {
                const tab = document.createElement('button');
                tab.className = 'tab';
                if (Number(dayNumber) === championship.currentDay) {
                    tab.classList.add('active');
                }
                tab.onclick = () => switchTab(Number(dayNumber));
                tab.dataset.day = dayNumber;
                tab.innerHTML = `
                    Journée ${dayNumber}
                    <button class="remove-day" onclick="event.stopPropagation(); removeDay(${dayNumber})" title="Supprimer">×</button>
                `;
                
                tabsContainer.insertBefore(tab, addButton);
            });
        }

        // SAUVEGARDE ET LOCALSTORAGE
        function saveToLocalStorage() {
            try {
                const championshipData = {
                    version: "2.0",
                    timestamp: new Date().toISOString(),
                    championship: championship
                };
                localStorage.setItem('tennisTableChampionship', JSON.stringify(championshipData));
                console.log('✅ Championnat sauvegardé automatiquement');
            } catch (error) {
                console.error('❌ Erreur sauvegarde localStorage:', error);
                showNotification('Erreur de sauvegarde', 'warning');
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('tennisTableChampionship');
                const oldData = localStorage.getItem('tennisTableTournament'); // Ancienne version
                
                if (savedData) {
                    const championshipData = JSON.parse(savedData);
                    championship = championshipData.championship || championship;
                    
                    updateTabsDisplay();
                    initializeAllDaysContent();
                    switchTab(championship.currentDay);
                    
                    console.log('✅ Championnat restauré depuis localStorage');
                    showNotification('Championnat restauré automatiquement', 'success');
                    
                } else if (oldData) {
                    // Migration depuis l'ancienne version
                    const oldTournamentData = JSON.parse(oldData);
                    championship.days[1] = {
                        players: oldTournamentData.players || { 1: [], 2: [], 3: [] },
                        matches: oldTournamentData.matches || { 1: [], 2: [], 3: [] }
                    };
                    
                    localStorage.removeItem('tennisTableTournament'); // Nettoyer l'ancienne version
                    saveToLocalStorage(); // Sauver dans le nouveau format
                    
                    updateTabsDisplay();
                    initializeAllDaysContent();
                    switchTab(1);
                    
                    showNotification('Données migrées vers le nouveau format !', 'info');
                }
            } catch (error) {
                console.error('❌ Erreur chargement localStorage:', error);
            }
        }

        function initializeAllDaysContent() {
            Object.keys(championship.days).forEach(dayNumber => {
                const dayNum = Number(dayNumber);
                if (dayNum > 1) {
                    createDayContent(dayNum);
                }
                initializeDivisionsDisplay(dayNum);
                updatePlayersDisplay(dayNum);
                updateMatchesDisplay(dayNum);
                updateStats(dayNum);
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // EXPORT / IMPORT
        function exportChampionship() {
            const championshipData = {
                version: "2.0",
                exportDate: new Date().toISOString(),
                championshipName: `Championnat_${new Date().toISOString().slice(0,10)}`,
                championship: championship,
                stats: calculateChampionshipStats()
            };

            const dataStr = JSON.stringify(championshipData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `championnat_tennis_table_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Championnat exporté avec succès !', 'success');
        }

        function calculateChampionshipStats() {
            let totalPlayers = new Set();
            let totalMatches = 0;
            let totalDays = Object.keys(championship.days).length;
            
            Object.values(championship.days).forEach(day => {
                Object.values(day.players).forEach(divPlayers => {
                    divPlayers.forEach(player => totalPlayers.add(player));
                });
                Object.values(day.matches).forEach(divMatches => {
                    totalMatches += divMatches.length;
                });
            });
            
            return {
                totalPlayers: totalPlayers.size,
                totalMatches,
                totalDays,
                uniquePlayersList: Array.from(totalPlayers)
            };
        }

        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
            document.getElementById('importFileInput').value = '';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('importFileInput').value = '';
            importedChampionshipData = null;
        }

        function handleChampionshipImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Supporter les deux formats (ancien et nouveau)
                    if (data.championship) {
                        importedChampionshipData = data;
                    } else if (data.players && data.matches) {
                        // Ancien format - convertir
                        importedChampionshipData = {
                            version: "2.0",
                            exportDate: data.timestamp || new Date().toISOString(),
                            championship: {
                                currentDay: 1,
                                days: {
                                    1: {
                                        players: data.players,
                                        matches: data.matches
                                    }
                                }
                            }
                        };
                    } else {
                        throw new Error('Format de fichier non reconnu');
                    }
                    
                    const importDate = new Date(importedChampionshipData.exportDate).toLocaleString('fr-FR');
                    const stats = importedChampionshipData.stats || calculateStatsFromData(importedChampionshipData.championship);
                    
                    const confirmMsg = `Confirmer l'import du championnat ?\n\n` +
                                     `📅 Exporté le : ${importDate}\n` +
                                     `🏆 Journées : ${stats.totalDays || Object.keys(importedChampionshipData.championship.days).length}\n` +
                                     `👥 Joueurs : ${stats.totalPlayers || 'Non calculé'}\n` +
                                     `🎯 Matchs : ${stats.totalMatches || 'Non calculé'}\n\n` +
                                     `⚠️ Cette action remplacera complètement le championnat actuel`;
                    
                    if (confirm(confirmMsg)) {
                        processImport();
                    } else {
                        closeImportModal();
                    }
                    
                } catch (error) {
                    alert('Erreur lors de la lecture du fichier :\n' + error.message + '\n\nVérifiez que le fichier est un export valide.');
                }
            };
            
            reader.readAsText(file);
        }

        function calculateStatsFromData(championshipData) {
            let totalPlayers = new Set();
            let totalMatches = 0;
            
            Object.values(championshipData.days).forEach(day => {
                Object.values(day.players).forEach(divPlayers => {
                    divPlayers.forEach(player => totalPlayers.add(player));
                });
                Object.values(day.matches).forEach(divMatches => {
                    totalMatches += divMatches.length;
                });
            });
            
            return {
                totalPlayers: totalPlayers.size,
                totalMatches,
                totalDays: Object.keys(championshipData.days).length
            };
        }

        function processImport() {
            if (!importedChampionshipData) {
                alert('Aucun fichier sélectionné');
                return;
            }
            
            try {
                championship = importedChampionshipData.championship;
                
                // Valider la structure
                if (!championship.days) {
                    championship.days = {};
                }
                if (!championship.currentDay) {
                    championship.currentDay = 1;
                }
                
                // Assurer la structure de chaque journée
                Object.keys(championship.days).forEach(dayNumber => {
                    const day = championship.days[dayNumber];
                    if (!day.players) day.players = { 1: [], 2: [], 3: [] };
                    if (!day.matches) day.matches = { 1: [], 2: [], 3: [] };
                    
                    for (let division = 1; division <= 3; division++) {
                        if (!Array.isArray(day.players[division])) day.players[division] = [];
                        if (!Array.isArray(day.matches[division])) day.matches[division] = [];
                    }
                });
                
                // Reconstruire l'interface
                updateTabsDisplay();
                initializeAllDaysContent();
                switchTab(championship.currentDay);
                saveToLocalStorage();
                
                closeImportModal();
                showNotification('Championnat importé avec succès !', 'success');
                
            } catch (error) {
                alert('Erreur lors de l\'import : ' + error.message);
            }
        }

        function clearAllData() {
            const stats = calculateChampionshipStats();
            const confirmMsg = `⚠️ ATTENTION ⚠️\n\n` +
                              `Cette action va SUPPRIMER DÉFINITIVEMENT :\n` +
                              `• ${stats.totalDays} journées\n` +
                              `• ${stats.totalPlayers} joueurs uniques\n` +
                              `• ${stats.totalMatches} matchs\n` +
                              `• Tous les scores et classements\n` +
                              `• La sauvegarde automatique\n\n` +
                              `Cette action est IRRÉVERSIBLE !\n\n` +
                              `Êtes-vous vraiment sûr ?`;
            
            if (confirm(confirmMsg)) {
                const doubleConfirm = confirm('Dernière confirmation :\n\nSupprimer TOUT le championnat ?');
                
                if (doubleConfirm) {
                    championship = {
                        currentDay: 1,
                        days: {
                            1: {
                                players: { 1: [], 2: [], 3: [] },
                                matches: { 1: [], 2: [], 3: [] }
                            }
                        }
                    };
                    
                    localStorage.removeItem('tennisTableChampionship');
                    
                    // Reconstruire l'interface
                    updateTabsDisplay();
                    initializeAllDaysContent();
                    switchTab(1);
                    
                    showNotification('Championnat réinitialisé', 'warning');
                }
            }
        }

        // GESTION DES JOUEURS
        function getCurrentDayData() {
            return championship.days[championship.currentDay];
        }

        function addPlayer() {
            addPlayerToDay(championship.currentDay);
        }

        function addPlayerToDay(dayNumber) {
            const nameInput = document.getElementById(`playerName${dayNumber > 1 ? '-' + dayNumber : ''}`);
            const divisionSelect = document.getElementById(`playerDivision${dayNumber > 1 ? '-' + dayNumber : ''}`);
            
            const name = nameInput.value.trim();
            const division = parseInt(divisionSelect.value);
            
            if (!name) {
                alert('Veuillez entrer un nom de joueur');
                return;
            }
            
            if (!championship.days[dayNumber]) {
                championship.days[dayNumber] = {
                    players: { 1: [], 2: [], 3: [] },
                    matches: { 1: [], 2: [], 3: [] }
                };
            }
            
            if (championship.days[dayNumber].players[division].includes(name)) {
                alert('Ce joueur existe déjà dans cette division pour cette journée');
                return;
            }
            
            championship.days[dayNumber].players[division].push(name);
            nameInput.value = '';
            updatePlayersDisplay(dayNumber);
            saveToLocalStorage();
        }

        function removePlayer(dayNumber, division, playerName) {
            championship.days[dayNumber].players[division] = championship.days[dayNumber].players[division].filter(p => p !== playerName);
            championship.days[dayNumber].matches[division] = championship.days[dayNumber].matches[division].filter(match => 
                match.player1 !== playerName && match.player2 !== playerName
            );
            updatePlayersDisplay(dayNumber);
            updateMatchesDisplay(dayNumber);
            updateStats(dayNumber);
            saveToLocalStorage();
        }

        function initializeDivisionsDisplay(dayNumber = 1) {
            const divisionsContainer = document.getElementById(`divisions-${dayNumber}`);
            if (!divisionsContainer) return;
            
            divisionsContainer.innerHTML = `
                <div class="division division-1">
                    <h3>🥇 Division 1</h3>
                    <div class="players-list" id="division${dayNumber}-1-players">
                        <div class="empty-state">Aucun joueur</div>
                    </div>
                    <div class="matches-container" id="division${dayNumber}-1-matches"></div>
                </div>
                
                <div class="division division-2">
                    <h3>🥈 Division 2</h3>
                    <div class="players-list" id="division${dayNumber}-2-players">
                        <div class="empty-state">Aucun joueur</div>
                    </div>
                    <div class="matches-container" id="division${dayNumber}-2-matches"></div>
                </div>
                
                <div class="division division-3">
                    <h3>🥉 Division 3</h3>
                    <div class="players-list" id="division${dayNumber}-3-players">
                        <div class="empty-state">Aucun joueur</div>
                    </div>
                    <div class="matches-container" id="division${dayNumber}-3-matches"></div>
                </div>
            `;
        }

        function updatePlayersDisplay(dayNumber) {
            if (!championship.days[dayNumber]) return;
            
            for (let division = 1; division <= 3; division++) {
                const container = document.getElementById(`division${dayNumber}-${division}-players`);
                if (!container) continue;
                
                const players = championship.days[dayNumber].players[division];
                
                if (players.length === 0) {
                    container.innerHTML = '<div class="empty-state">Aucun joueur</div>';
                } else {
                    container.innerHTML = players.map(player => 
                        `<div class="player-tag" onclick="showPlayerDetails(${dayNumber}, ${division}, '${player}')">
                            ${player}
                            <button class="remove-player" onclick="event.stopPropagation(); removePlayer(${dayNumber}, ${division}, '${player}')" title="Supprimer">×</button>
                        </div>`
                    ).join('');
                }
            }
        }

        // Import et bulk (adapté pour journées multiples)
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data;
                    
                    if (file.name.endsWith('.csv')) {
                        const text = e.target.result;
                        data = parseCSV(text);
                    } else {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        data = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    }
                    
                    importPlayersFromData(data, championship.currentDay);
                    
                } catch (error) {
                    alert('Erreur lors de la lecture du fichier : ' + error.message);
                }
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            return lines.map(line => {
                return line.split(/[,;]/).map(cell => cell.trim().replace(/^"(.*)"$/, '$1'));
            }).filter(row => row[0] && row[0].trim());
        }

        function importPlayersFromData(data, dayNumber) {
            let imported = 0;
            let errors = [];
            
            data.forEach((row, index) => {
                if (row.length >= 2) {
                    const name = String(row[0]).trim();
                    const division = parseInt(row[1]);
                    
                    if (name && [1, 2, 3].includes(division)) {
                        if (!championship.days[dayNumber].players[division].includes(name)) {
                            championship.days[dayNumber].players[division].push(name);
                            imported++;
                        }
                    } else {
                        errors.push(`Ligne ${index + 1}: "${row[0]}" division "${row[1]}" invalide`);
                    }
                }
            });
            
            updatePlayersDisplay(dayNumber);
            saveToLocalStorage();
            
            let message = `✅ ${imported} joueurs importés avec succès dans la Journée ${dayNumber} !`;
            if (errors.length > 0 && errors.length < 5) {
                message += '\n\n⚠️ Erreurs:\n' + errors.slice(0, 5).join('\n');
            } else if (errors.length >= 5) {
                message += `\n\n⚠️ ${errors.length} erreurs détectées. Vérifiez le format.`;
            }
            
            alert(message);
            document.getElementById('fileInput').value = '';
        }

        function showBulkInput() {
            const division = document.getElementById('bulkDivision').value;
            document.getElementById('selectedDivision').textContent = `Division ${division}`;
            document.getElementById('bulkModal').style.display = 'block';
            document.getElementById('bulkText').focus();
        }

        function closeBulkModal() {
            document.getElementById('bulkModal').style.display = 'none';
            document.getElementById('bulkText').value = '';
        }

        function addBulkPlayers() {
            const text = document.getElementById('bulkText').value.trim();
            const division = parseInt(document.getElementById('bulkDivision').value);
            const dayNumber = championship.currentDay;
            
            if (!text) {
                alert('Veuillez entrer au moins un nom de joueur');
                return;
            }
            
            const names = text.split('\n')
                             .map(name => name.trim())
                             .filter(name => name.length > 0);
            
            let added = 0;
            let duplicates = [];
            
            names.forEach(name => {
                if (!championship.days[dayNumber].players[division].includes(name)) {
                    championship.days[dayNumber].players[division].push(name);
                    added++;
                } else {
                    duplicates.push(name);
                }
            });
            
            updatePlayersDisplay(dayNumber);
            saveToLocalStorage();
            
            let message = `✅ ${added} joueurs ajoutés à la Division ${division} - Journée ${dayNumber} !`;
            if (duplicates.length > 0) {
                message += `\n\n⚠️ Joueurs déjà présents (ignorés): ${duplicates.join(', ')}`;
            }
            
            alert(message);
            closeBulkModal();
        }

        // GÉNÉRATION DES MATCHS
        function generateMatches() {
            generateMatchesForDay(championship.currentDay);
        }

        function generateMatchesForDay(dayNumber) {
            const dayData = championship.days[dayNumber];
            if (!dayData) return;
            
            for (let division = 1; division <= 3; division++) {
                const divisionPlayers = [...dayData.players[division]];
                
                if (divisionPlayers.length < 2) {
                    if (divisionPlayers.length === 1) {
                        alert(`Journée ${dayNumber} - Division ${division}: Il faut au moins 2 joueurs pour générer des matchs`);
                    }
                    continue;
                }
                
                dayData.matches[division] = [];
                
                const totalRounds = 4;
                const playersWithBye = [...divisionPlayers];
                
                const isOddNumber = playersWithBye.length % 2 !== 0;
                if (isOddNumber) {
                    playersWithBye.push("BYE");
                }
                
                const numPlayers = playersWithBye.length;
                
                for (let tour = 1; tour <= totalRounds; tour++) {
                    for (let i = 0; i < numPlayers / 2; i++) {
                        let player1Index, player2Index;
                        
                        if (i === 0) {
                            player1Index = 0;
                            player2Index = numPlayers - 1;
                        } else {
                            player1Index = i;
                            player2Index = numPlayers - 1 - i;
                        }
                        
                        if (tour > 1) {
                            const rotation = tour - 1;
                            if (player1Index !== 0) {
                                player1Index = (player1Index + rotation - 1) % (numPlayers - 1) + 1;
                            }
                            if (player2Index !== 0) {
                                player2Index = (player2Index + rotation - 1) % (numPlayers - 1) + 1;
                            }
                        }
                        
                        const player1 = playersWithBye[player1Index];
                        const player2 = playersWithBye[player2Index];
                        
                        if (player1 !== "BYE" && player2 !== "BYE") {
                            const matchData = {
                                player1: player1,
                                player2: player2,
                                tour: tour,
                                sets: [
                                    { player1Score: '', player2Score: '' },
                                    { player1Score: '', player2Score: '' },
                                    { player1Score: '', player2Score: '' }
                                ],
                                completed: false,
                                winner: null
                            };
                            
                            dayData.matches[division].push(matchData);
                        }
                    }
                }
                
                dayData.matches[division] = shuffleArray([...dayData.matches[division]]);
            }
            
            updateMatchesDisplay(dayNumber);
            updateStats(dayNumber);
            saveToLocalStorage();
            
            let summary = `Matchs générés avec succès pour la Journée ${dayNumber} !\n\n`;
            for (let division = 1; division <= 3; division++) {
                if (dayData.players[division].length > 0) {
                    const totalMatches = dayData.matches[division].length;
                    const playersCount = dayData.players[division].length;
                    const isOdd = playersCount % 2 !== 0;
                    
                    summary += `Division ${division}: ${playersCount} joueurs, ${totalMatches} matchs`;
                    if (isOdd) {
                        summary += ` (avec rotation des byes)`;
                    }
                    summary += `\n`;
                }
            }
            alert(summary);
        }
        
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // AFFICHAGE DES MATCHS
        function updateMatchesDisplay(dayNumber) {
            const dayData = championship.days[dayNumber];
            if (!dayData) return;
            
            for (let division = 1; division <= 3; division++) {
                const container = document.getElementById(`division${dayNumber}-${division}-matches`);
                if (!container) continue;
                
                if (dayData.matches[division].length === 0) {
                    container.innerHTML = '';
                    continue;
                }
                
                const matchsByTour = {};
                dayData.matches[division].forEach(match => {
                    if (!matchsByTour[match.tour]) {
                        matchsByTour[match.tour] = [];
                    }
                    matchsByTour[match.tour].push(match);
                });
                
                let html = '';
                
                for (let tour = 1; tour <= 4; tour++) {
                    if (matchsByTour[tour] && matchsByTour[tour].length > 0) {
                        const tourMatches = matchsByTour[tour];
                        const completedMatches = tourMatches.filter(m => m.completed).length;
                        const totalMatches = tourMatches.length;
                        
                        html += `
                            <div class="tour-section">
                                <div class="tour-header" onclick="toggleTour(${dayNumber}, ${division}, ${tour})">
                                    <div class="tour-title">🎯 Tour ${tour}</div>
                                    <div class="tour-progress" id="progress-d${dayNumber}-div${division}-t${tour}">${completedMatches}/${totalMatches} terminés</div>
                                </div>
                                <div class="tour-matches" id="tour${dayNumber}-${division}-${tour}">
                        `;
                        
                        tourMatches.forEach((match, matchIndex) => {
                            const globalIndex = dayData.matches[division].indexOf(match);
                            const matchStatus = match.completed ? 'completed' : 'pending';
                            const statusClass = match.completed ? 'status-completed' : 'status-pending';
                            const statusText = match.completed ? 'Terminé' : 'En cours';
                            
                            html += `
                                <div class="match ${matchStatus}" data-match-id="d${dayNumber}-div${division}-m${globalIndex}">
                                    <div class="match-header">
                                        <div class="player-names">${match.player1} VS ${match.player2}</div>
                                        <div class="match-status ${statusClass}">${statusText}</div>
                                    </div>
                                    <div class="sets-container">
                            `;
                            
                            for (let setIndex = 0; setIndex < 3; setIndex++) {
                                let setClass = 'set';
                                let setDisabled = '';
                                
                                if (match.completed && setIndex === 2) {
                                    let player1Sets = 0;
                                    let player2Sets = 0;
                                    
                                    for (let i = 0; i < 2; i++) {
                                        if (match.sets[i] && match.sets[i].player1Score !== '' && match.sets[i].player2Score !== '') {
                                            const score1 = parseInt(match.sets[i].player1Score);
                                            const score2 = parseInt(match.sets[i].player2Score);
                                            
                                            if (score1 > score2) {
                                                player1Sets++;
                                            } else if (score2 > score1) {
                                                player2Sets++;
                                            }
                                        }
                                    }
                                    
                                    if (player1Sets >= 2 || player2Sets >= 2) {
                                        setClass += ' set-disabled';
                                        setDisabled = 'disabled';
                                    }
                                }
                                
                                html += `
                                    <div class="${setClass}">
                                        <div class="set-label">Set ${setIndex + 1}</div>
                                        <div class="set-scores">
                                            <input type="number" class="score-input" 
                                                   placeholder="" min="0" max="30"
                                                   value="${match.sets[setIndex].player1Score || ''}" 
                                                   ${setDisabled}
                                                   onchange="updateSetScore(${dayNumber}, ${division}, ${globalIndex}, ${setIndex}, 'player1Score', this.value)"
                                                   onkeydown="handleEnterKey(event, ${dayNumber}, ${division}, ${globalIndex})">
                                            <span class="score-separator">-</span>
                                            <input type="number" class="score-input" 
                                                   placeholder="" min="0" max="30"
                                                   value="${match.sets[setIndex].player2Score || ''}"
                                                   ${setDisabled}
                                                   onchange="updateSetScore(${dayNumber}, ${division}, ${globalIndex}, ${setIndex}, 'player2Score', this.value)"
                                                   onkeydown="handleEnterKey(event, ${dayNumber}, ${division}, ${globalIndex})">
                                        </div>
                                    </div>
                                `;
                            }
                            
                            let resultText = 'En attente des résultats';
                            let resultClass = 'result-pending';
                            
                            if (match.completed && match.winner) {
                                let player1Sets = 0;
                                let player2Sets = 0;
                                
                                match.sets.forEach(set => {
                                    if (set.player1Score !== '' && set.player2Score !== '') {
                                        const score1 = parseInt(set.player1Score);
                                        const score2 = parseInt(set.player2Score);
                                        
                                        if (score1 > score2) {
                                            player1Sets++;
                                        } else if (score2 > score1) {
                                            player2Sets++;
                                        }
                                    }
                                });
                                
                                const winnerSets = match.winner === match.player1 ? player1Sets : player2Sets;
                                const loserSets = match.winner === match.player1 ? player2Sets : player1Sets;
                                
                                resultText = `🏆 ${match.winner} remporte le match (${winnerSets}-${loserSets})`;
                                resultClass = 'result-completed';
                            }
                            
                            html += `
                                    </div>
                                    <div class="match-result ${resultClass}">
                                        ${resultText}
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                }
                
                container.innerHTML = html;
                
                setTimeout(() => {
                    const firstTour = document.getElementById(`tour${dayNumber}-${division}-1`);
                    if (firstTour) {
                        firstTour.classList.add('active');
                    }
                }, 100);
            }
        }

        function toggleTour(dayNumber, division, tour) {
            const tourElement = document.getElementById(`tour${dayNumber}-${division}-${tour}`);
            if (tourElement) {
                tourElement.classList.toggle('active');
            }
        }

        function updateSetScore(dayNumber, division, matchIndex, setIndex, scoreField, value) {
            championship.days[dayNumber].matches[division][matchIndex].sets[setIndex][scoreField] = value;
        }

        function handleEnterKey(event, dayNumber, division, matchIndex) {
            if (event.key === 'Enter') {
                const currentValue = event.target.value;
                event.target.dispatchEvent(new Event('change'));
                
                const wasCompleted = championship.days[dayNumber].matches[division][matchIndex].completed;
                
                checkMatchCompletion(dayNumber, division, matchIndex);
                
                const isNowCompleted = championship.days[dayNumber].matches[division][matchIndex].completed;
                
                updateSingleMatchDisplay(dayNumber, division, matchIndex);
                saveToLocalStorage();
                
                const matchElement = document.querySelector(`[data-match-id="d${dayNumber}-div${division}-m${matchIndex}"]`);
                if (matchElement) {
                    matchElement.style.transform = 'scale(1.02)';
                    matchElement.style.boxShadow = '0 5px 20px rgba(27, 164, 60, 0.4)';
                    matchElement.style.transition = 'all 0.3s ease';
                    
                    setTimeout(() => {
                        matchElement.style.transform = '';
                        matchElement.style.boxShadow = '';
                    }, 400);
                }
                
                if (!wasCompleted && isNowCompleted) {
                    const match = championship.days[dayNumber].matches[division][matchIndex];
                    setTimeout(() => {
                        if (matchElement) {
                            matchElement.style.background = '#d5f4e6';
                            matchElement.style.borderColor = '#27ae60';
                        }
                    }, 200);
                }
            }
        }

        function updateSingleMatchDisplay(dayNumber, division, matchIndex) {
            const match = championship.days[dayNumber].matches[division][matchIndex];
            const matchElement = document.querySelector(`[data-match-id="d${dayNumber}-div${division}-m${matchIndex}"]`);
            
            if (!matchElement) return;
            
            const statusElement = matchElement.querySelector('.match-status');
            if (statusElement) {
                if (match.completed) {
                    statusElement.className = 'match-status status-completed';
                    statusElement.textContent = 'Terminé';
                    matchElement.classList.add('completed');
                } else {
                    statusElement.className = 'match-status status-pending';
                    statusElement.textContent = 'En cours';
                    matchElement.classList.remove('completed');
                }
            }
            
            const resultElement = matchElement.querySelector('.match-result');
            if (resultElement) {
                let resultText = 'En attente des résultats';
                let resultClass = 'result-pending';
                
                if (match.completed && match.winner) {
                    let player1Sets = 0;
                    let player2Sets = 0;
                    
                    match.sets.forEach(set => {
                        if (set.player1Score !== '' && set.player2Score !== '') {
                            const score1 = parseInt(set.player1Score);
                            const score2 = parseInt(set.player2Score);
                            if (score1 > score2) player1Sets++;
                            else if (score2 > score1) player2Sets++;
                        }
                    });
                    
                    const winnerSets = match.winner === match.player1 ? player1Sets : player2Sets;
                    const loserSets = match.winner === match.player1 ? player2Sets : player1Sets;
                    
                    resultText = `🏆 ${match.winner} remporte le match (${winnerSets}-${loserSets})`;
                    resultClass = 'result-completed';
                }
                
                resultElement.className = `match-result ${resultClass}`;
                resultElement.textContent = resultText;
            }
            
            if (match.completed) {
                const set3Inputs = matchElement.querySelectorAll('.set:nth-child(3) .score-input');
                set3Inputs.forEach(input => {
                    input.disabled = true;
                    input.parentElement.parentElement.classList.add('set-disabled');
                });
            }
            
            updateTourProgress(dayNumber, division, match.tour);
        }

        function updateTourProgress(dayNumber, division, tour) {
            const progressElement = document.getElementById(`progress-d${dayNumber}-div${division}-t${tour}`);
            if (!progressElement) return;
            
            const tourMatches = championship.days[dayNumber].matches[division].filter(m => m.tour === tour);
            const completedMatches = tourMatches.filter(m => m.completed).length;
            const totalMatches = tourMatches.length;
            
            progressElement.textContent = `${completedMatches}/${totalMatches} terminés`;
            
            progressElement.style.background = 'rgba(46, 204, 113, 0.3)';
            setTimeout(() => {
                progressElement.style.background = 'rgba(255,255,255,0.2)';
            }, 500);
        }

        function checkMatchCompletion(dayNumber, division, matchIndex) {
            const match = championship.days[dayNumber].matches[division][matchIndex];
            let player1Sets = 0;
            let player2Sets = 0;
            
            match.sets.forEach((set, index) => {
                if (set.player1Score !== '' && set.player2Score !== '') {
                    const score1 = parseInt(set.player1Score);
                    const score2 = parseInt(set.player2Score);
                    
                    if (score1 > score2) {
                        player1Sets++;
                    } else if (score2 > score1) {
                        player2Sets++;
                    }
                }
            });
            
            match.completed = false;
            match.winner = null;
            
            if (player1Sets >= 2) {
                match.completed = true;
                match.winner = match.player1;
            } else if (player2Sets >= 2) {
                match.completed = true;
                match.winner = match.player2;
            }
        }

        // STATISTIQUES ET CLASSEMENTS
        function updateRankings() {
            updateRankingsForDay(championship.currentDay);
        }

        function updateStats(dayNumber) {
            const dayData = championship.days[dayNumber];
            if (!dayData) return;
            
            let totalPlayers = 0;
            let totalMatches = 0;
            let completedMatches = 0;
            
            for (let division = 1; division <= 3; division++) {
                totalPlayers += dayData.players[division].length;
                totalMatches += dayData.matches[division].length;
                
                dayData.matches[division].forEach((match, index) => {
                    checkMatchCompletion(dayNumber, division, index);
                    if (match.completed) completedMatches++;
                });
            }
            
            const statsDiv = document.getElementById(`stats-${dayNumber}`);
            const statsContent = document.getElementById(`statsContent-${dayNumber}`);
            
            if (!statsDiv || !statsContent) return;
            
            if (totalMatches > 0) {
                statsDiv.style.display = 'block';
                const completionRate = Math.round((completedMatches / totalMatches) * 100);
                
                let tourStats = '';
                for (let tour = 1; tour <= 4; tour++) {
                    let tourTotal = 0;
                    let tourCompleted = 0;
                    
                    for (let division = 1; division <= 3; division++) {
                        const tourMatches = dayData.matches[division].filter(m => m.tour === tour);
                        tourTotal += tourMatches.length;
                        tourCompleted += tourMatches.filter(m => m.completed).length;
                    }
                    
                    if (tourTotal > 0) {
                        const tourRate = Math.round((tourCompleted / tourTotal) * 100);
                        tourStats += `
                            <div class="stat-card">
                                <div class="stat-number">${tourRate}%</div>
                                <div>Tour ${tour} (${tourCompleted}/${tourTotal})</div>
                            </div>
                        `;
                    }
                }
                
                statsContent.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${totalPlayers}</div>
                        <div>Joueurs inscrits</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalMatches}</div>
                        <div>Matchs générés</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${completedMatches}</div>
                        <div>Matchs terminés</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${completionRate}%</div>
                        <div>Progression</div>
                    </div>
                    ${tourStats}
                `;
            } else {
                statsDiv.style.display = 'none';
            }
        }

        function calculatePlayerStats(dayNumber, division, playerName) {
            const dayData = championship.days[dayNumber];
            if (!dayData) return null;
            
            const playerMatches = dayData.matches[division].filter(match => 
                match.player1 === playerName || match.player2 === playerName
            );
            
            let wins = 0;
            let losses = 0;
            let setsWon = 0;
            let setsLost = 0;
            let pointsWon = 0;
            let pointsLost = 0;
            let matchesPlayed = 0;
            
            playerMatches.forEach(match => {
                checkMatchCompletion(dayNumber, division, dayData.matches[division].indexOf(match));
                
                if (match.completed) {
                    matchesPlayed++;
                    const isPlayer1 = match.player1 === playerName;
                    
                    if (match.winner === playerName) {
                        wins++;
                    } else {
                        losses++;
                    }
                    
                    match.sets.forEach(set => {
                        if (set.player1Score !== '' && set.player2Score !== '') {
                            const score1 = parseInt(set.player1Score);
                            const score2 = parseInt(set.player2Score);
                            
                            if (isPlayer1) {
                                pointsWon += score1;
                                pointsLost += score2;
                                if (score1 > score2) setsWon++;
                                else if (score2 > score1) setsLost++;
                            } else {
                                pointsWon += score2;
                                pointsLost += score1;
                                if (score2 > score1) setsWon++;
                                else if (score1 > score2) setsLost++;
                            }
                        }
                    });
                }
            });
            
            const winRate = matchesPlayed > 0 ? Math.round((wins / matchesPlayed) * 100) : 0;
            const totalPoints = wins * 3 + losses * 1;
            
            return {
                matchesPlayed,
                wins,
                losses,
                setsWon,
                setsLost,
                pointsWon,
                pointsLost,
                winRate,
                totalPoints,
                matches: playerMatches
            };
        }

        function showPlayerDetails(dayNumber, division, playerName) {
            const stats = calculatePlayerStats(dayNumber, division, playerName);
            if (!stats) return;
            
            document.getElementById('playerNameTitle').textContent = `${playerName} - Division ${division} - Journée ${dayNumber}`;
            
            document.getElementById('playerOverview').innerHTML = `
                <div class="overview-card">
                    <div class="overview-number">${stats.matchesPlayed}</div>
                    <div class="overview-label">Matchs joués</div>
                </div>
                <div class="overview-card">
                    <div class="overview-number">${stats.wins}</div>
                    <div class="overview-label">Victoires</div>
                </div>
                <div class="overview-card">
                    <div class="overview-number">${stats.winRate}%</div>
                    <div class="overview-label">% Victoires</div>
                </div>
                <div class="overview-card">
                    <div class="overview-number">${stats.setsWon}/${stats.setsLost}</div>
                    <div class="overview-label">Sets G/P</div>
                </div>
                <div class="overview-card">
                    <div class="overview-number">${stats.pointsWon}/${stats.pointsLost}</div>
                    <div class="overview-label">Points G/P</div>
                </div>
                <div class="overview-card">
                    <div class="overview-number">${stats.totalPoints}</div>
                    <div class="overview-label">Points journée</div>
                </div>
            `;
            
            let matchesHtml = '';
            stats.matches.forEach(match => {
                const isPlayer1 = match.player1 === playerName;
                const opponent = isPlayer1 ? match.player2 : match.player1;
                const resultClass = match.completed ? (match.winner === playerName ? 'win' : 'loss') : '';
                const resultText = match.completed ? (match.winner === playerName ? 'Victoire' : 'Défaite') : 'En cours';
                
                let setsScore = '';
                if (match.completed) {
                    let playerSets = 0;
                    let opponentSets = 0;
                    
                    match.sets.forEach(set => {
                        if (set.player1Score !== '' && set.player2Score !== '') {
                            const score1 = parseInt(set.player1Score);
                            const score2 = parseInt(set.player2Score);
                            
                            if ((isPlayer1 && score1 > score2) || (!isPlayer1 && score2 > score1)) {
                                playerSets++;
                            } else if (score1 !== score2) {
                                opponentSets++;
                            }
                        }
                    });
                    setsScore = `(${playerSets}-${opponentSets})`;
                }
                
                matchesHtml += `
                    <div class="history-match ${resultClass}">
                        <div>
                            <div class="history-opponent">VS ${opponent}</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Tour ${match.tour}</div>
                        </div>
                        <div class="history-score">
                            ${resultText} ${setsScore}
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('playerMatches').innerHTML = matchesHtml || '<p style="text-align: center; color: #7f8c8d;">Aucun match joué</p>';
            document.getElementById('playerModal').style.display = 'block';
        }

        function closePlayerModal() {
            document.getElementById('playerModal').style.display = 'none';
        }

        function showRankings(type) {
            showRankingsForDay(championship.currentDay, type);
        }

        function showRankingsForDay(dayNumber, type) {
            document.querySelectorAll(`#rankings-${dayNumber} .toggle-btn`).forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateRankingsForDay(dayNumber, type);
        }

        function updateRankingsForDay(dayNumber, sortBy = 'points') {
            const dayData = championship.days[dayNumber];
            if (!dayData) return;
            
            let rankingsHtml = '';
            let hasAnyMatches = false;
            
            for (let division = 1; division <= 3; division++) {
                if (dayData.matches[division].some(match => {
                    checkMatchCompletion(dayNumber, division, dayData.matches[division].indexOf(match));
                    return match.completed;
                })) {
                    hasAnyMatches = true;
                    break;
                }
            }
            
            if (!hasAnyMatches) {
                alert(`Aucun match terminé dans la Journée ${dayNumber} pour établir un classement !`);
                return;
            }
            
            for (let division = 1; division <= 3; division++) {
                if (dayData.players[division].length === 0) continue;
                
                const playerStats = dayData.players[division].map(player => ({
                    name: player,
                    ...calculatePlayerStats(dayNumber, division, player)
                }));
                
                if (sortBy === 'points') {
                    playerStats.sort((a, b) => {
                        if (b.totalPoints !== a.totalPoints) return b.totalPoints - a.totalPoints;
                        if (b.winRate !== a.winRate) return b.winRate - a.winRate;
                        return b.setsWon - a.setsWon;
                    });
                } else {
                    playerStats.sort((a, b) => {
                        if (b.winRate !== a.winRate) return b.winRate - a.winRate;
                        if (b.wins !== a.wins) return b.wins - a.wins;
                        return b.setsWon - a.setsWon;
                    });
                }
                
                rankingsHtml += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">
                            ${division === 1 ? '🥇' : division === 2 ? '🥈' : '🥉'} Division ${division}
                        </h3>
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>Joueur</th>
                                    <th>Points</th>
                                    <th>V/D</th>
                                    <th>% Vict.</th>
                                    <th>Sets</th>
                                    <th>Matchs</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                playerStats.forEach((player, index) => {
                    const rankClass = index === 0 ? 'rank-gold' : index === 1 ? 'rank-silver' : index === 2 ? 'rank-bronze' : '';
                    
                    rankingsHtml += `
                        <tr style="cursor: pointer;" onclick="showPlayerDetails(${dayNumber}, ${division}, '${player.name}')">
                            <td class="rank-position ${rankClass}">${index + 1}</td>
                            <td style="font-weight: 600;">${player.name}</td>
                            <td class="stat-value">${player.totalPoints}</td>
                            <td>${player.wins}/${player.losses}</td>
                            <td>${player.winRate}%</td>
                            <td>${player.setsWon}/${player.setsLost}</td>
                            <td>${player.matchesPlayed}</td>
                        </tr>
                    `;
                });
                
                rankingsHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            const rankingsContentEl = document.getElementById(`rankingsContent-${dayNumber}`);
            const rankingsEl = document.getElementById(`rankings-${dayNumber}`);
            
            if (rankingsContentEl && rankingsEl) {
                rankingsContentEl.innerHTML = rankingsHtml;
                rankingsEl.style.display = 'block';
                rankingsEl.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // CLASSEMENT GÉNÉRAL
        function updateGeneralRanking() {
            const generalStats = calculateGeneralStats();
            
            // Mettre à jour les statistiques générales
            document.getElementById('generalStats').innerHTML = `
                <div class="general-stat-card">
                    <div class="general-stat-number">${generalStats.totalDays}</div>
                    <div class="general-stat-label">Journées</div>
                </div>
                <div class="general-stat-card">
                    <div class="general-stat-number">${generalStats.totalPlayers}</div>
                    <div class="general-stat-label">Joueurs uniques</div>
                </div>
                <div class="general-stat-card">
                    <div class="general-stat-number">${generalStats.totalMatches}</div>
                    <div class="general-stat-label">Matchs joués</div>
                </div>
                <div class="general-stat-card">
                    <div class="general-stat-number">${generalStats.completedMatches}</div>
                    <div class="general-stat-label">Matchs terminés</div>
                </div>
            `;
            
            // Calculer le classement général par division
            const generalRanking = calculateGeneralRanking();
            
            if (!generalRanking.hasData) {
                document.getElementById('generalRankingContent').innerHTML = `
                    <div class="empty-state">
                        Terminez au moins un match dans une journée pour voir le classement général
                    </div>
                `;
                return;
            }
            
            let rankingHtml = '';
            
            for (let division = 1; division <= 3; division++) {
                if (generalRanking.divisions[division].length === 0) continue;
                
                rankingHtml += `
                    <div style="margin-bottom: 40px;">
                        <h3 style="color: #e67e22; margin-bottom: 20px; font-size: 1.4rem;">
                            ${division === 1 ? '🥇' : division === 2 ? '🥈' : '🥉'} Division ${division} - Classement Général
                        </h3>
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>Joueur</th>
                                    <th>Points Total</th>
                                    <th>Journées</th>
                                    <th>V/D Global</th>
                                    <th>% Vict. Moy.</th>
                                    <th>Sets Global</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                generalRanking.divisions[division].forEach((player, index) => {
                    const rankClass = index === 0 ? 'rank-gold' : index === 1 ? 'rank-silver' : index === 2 ? 'rank-bronze' : '';
                    
                    rankingHtml += `
                        <tr style="cursor: pointer;" onclick="showGeneralPlayerDetails('${player.name}', ${division})">
                            <td class="rank-position ${rankClass}">${index + 1}</td>
                            <td style="font-weight: 600;">${player.name}</td>
                            <td class="stat-value">${player.totalPoints}</td>
                            <td>${player.daysPlayed}</td>
                            <td>${player.totalWins}/${player.totalLosses}</td>
                            <td>${player.avgWinRate}%</td>
                            <td>${player.totalSetsWon}/${player.totalSetsLost}</td>
                        </tr>
                    `;
                });
                
                rankingHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            document.getElementById('generalRankingContent').innerHTML = rankingHtml;
            showNotification('Classement général mis à jour !', 'success');
        }

        function calculateGeneralStats() {
            let totalPlayers = new Set();
            let totalMatches = 0;
            let completedMatches = 0;
            let totalDays = Object.keys(championship.days).length;
            
            Object.values(championship.days).forEach(day => {
                Object.values(day.players).forEach(divPlayers => {
                    divPlayers.forEach(player => totalPlayers.add(player));
                });
                Object.values(day.matches).forEach(divMatches => {
                    totalMatches += divMatches.length;
                    completedMatches += divMatches.filter(match => match.completed).length;
                });
            });
            
            return {
                totalDays,
                totalPlayers: totalPlayers.size,
                totalMatches,
                completedMatches
            };
        }

        function calculateGeneralRanking() {
            const generalRanking = {
                hasData: false,
                divisions: { 1: [], 2: [], 3: [] }
            };
            
            // Collecter tous les joueurs et leurs stats par division
            for (let division = 1; division <= 3; division++) {
                const playersData = {};
                
                Object.keys(championship.days).forEach(dayNumber => {
                    const dayNum = parseInt(dayNumber);
                    const dayData = championship.days[dayNum];
                    
                    dayData.players[division].forEach(playerName => {
                        if (!playersData[playerName]) {
                            playersData[playerName] = {
                                name: playerName,
                                daysPlayed: 0,
                                totalPoints: 0,
                                totalWins: 0,
                                totalLosses: 0,
                                totalSetsWon: 0,
                                totalSetsLost: 0,
                                totalMatchesPlayed: 0,
                                winRates: []
                            };
                        }
                        
                        const dayStats = calculatePlayerStats(dayNum, division, playerName);
                        if (dayStats && dayStats.matchesPlayed > 0) {
                            playersData[playerName].daysPlayed++;
                            playersData[playerName].totalPoints += dayStats.totalPoints;
                            playersData[playerName].totalWins += dayStats.wins;
                            playersData[playerName].totalLosses += dayStats.losses;
                            playersData[playerName].totalSetsWon += dayStats.setsWon;
                            playersData[playerName].totalSetsLost += dayStats.setsLost;
                            playersData[playerName].totalMatchesPlayed += dayStats.matchesPlayed;
                            playersData[playerName].winRates.push(dayStats.winRate);
                            
                            generalRanking.hasData = true;
                        }
                    });
                });
                
                // Calculer le pourcentage de victoire moyen et trier
                const playersArray = Object.values(playersData)
                    .filter(player => player.daysPlayed > 0)
                    .map(player => ({
                        ...player,
                        avgWinRate: player.winRates.length > 0 ? 
                            Math.round(player.winRates.reduce((a, b) => a + b, 0) / player.winRates.length) : 0
                    }))
                    .sort((a, b) => {
                        if (b.totalPoints !== a.totalPoints) return b.totalPoints - a.totalPoints;
                        if (b.avgWinRate !== a.avgWinRate) return b.avgWinRate - a.avgWinRate;
                        return b.totalSetsWon - a.totalSetsWon;
                    });
                
                generalRanking.divisions[division] = playersArray;
            }
            
            return generalRanking;
        }

        function showGeneralPlayerDetails(playerName, division) {
            const playerHistory = [];
            
            Object.keys(championship.days).sort((a, b) => Number(a) - Number(b)).forEach(dayNumber => {
                const dayNum = parseInt(dayNumber);
                const dayData = championship.days[dayNum];
                
                if (dayData.players[division].includes(playerName)) {
                    const dayStats = calculatePlayerStats(dayNum, division, playerName);
                    if (dayStats && dayStats.matchesPlayed > 0) {
                        playerHistory.push({
                            day: dayNum,
                            ...dayStats
                        });
                    }
                }
            });
            
            if (playerHistory.length === 0) {
                alert('Aucun match joué par ce joueur');
                return;
            }
            
            // Calculer les totaux
            const totals = playerHistory.reduce((acc, day) => ({
                totalPoints: acc.totalPoints + day.totalPoints,
                totalWins: acc.totalWins + day.wins,
                totalLosses: acc.totalLosses + day.losses,
                totalSetsWon: acc.totalSetsWon + day.setsWon,
                totalSetsLost: acc.totalSetsLost + day.setsLost,
                totalMatchesPlayed: acc.totalMatchesPlayed + day.matchesPlayed
            }), {
                totalPoints: 0,
                totalWins: 0,
                totalLosses: 0,
                totalSetsWon: 0,
                totalSetsLost: 0,
                totalMatchesPlayed: 0
            });
            
            const avgWinRate = totals.totalMatchesPlayed > 0 ? 
                Math.round((totals.totalWins / totals.totalMatchesPlayed) * 100) : 0;
            
            document.getElementById('playerNameTitle').textContent = `${playerName} - Division ${division} - Vue Générale`;
            
            document.getElementById('playerOverview').innerHTML = `
                <div class="overview-card">
                    <div class="overview-number">${playerHistory.length}</div>
                    <div class="overview-label">Journées jouées</div>
                </div>
                <div class="overview-card">
                    <div class="overview-number">${totals.totalPoints}</div>
                    <div class="overview-label">Points total</div>
                </div>
                <div class="overview-card">
                    <div class="overview-number">${totals.totalWins}/${totals.totalLosses}</div>
                    <div class="overview-label">V/D Global</div>
                </div>
                <div class="overview-card">
                    <div class="overview-number">${avgWinRate}%</div>
                    <div class="overview-label">% Victoires</div>
                </div>
                <div class="overview-card">
                    <div class="overview-number">${totals.totalSetsWon}/${totals.totalSetsLost}</div>
                    <div class="overview-label">Sets Global</div>
                </div>
                <div class="overview-card">
                    <div class="overview-number">${totals.totalMatchesPlayed}</div>
                    <div class="overview-label">Matchs total</div>
                </div>
            `;
            
            let historyHtml = '<h4 style="color: #2c3e50; margin-bottom: 15px;">📈 Performance par journée</h4>';
            playerHistory.forEach(dayStats => {
                const performanceClass = dayStats.winRate >= 60 ? 'win' : dayStats.winRate >= 40 ? '' : 'loss';
                
                historyHtml += `
                    <div class="history-match ${performanceClass}">
                        <div>
                            <div class="history-opponent">Journée ${dayStats.day}</div>
                            <div style="font-size: 12px; color: #7f8c8d;">
                                ${dayStats.wins}V/${dayStats.losses}D - ${dayStats.matchesPlayed} matchs
                            </div>
                        </div>
                        <div class="history-score">
                            <div style="font-weight: bold;">${dayStats.totalPoints} pts</div>
                            <div style="font-size: 12px;">${dayStats.winRate}% vict.</div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('playerMatches').innerHTML = historyHtml;
            document.getElementById('playerModal').style.display = 'block';
        }

        function exportGeneralRanking() {
            const generalRanking = calculateGeneralRanking();
            const generalStats = calculateGeneralStats();
            
            const exportData = {
                version: "2.0",
                exportDate: new Date().toISOString(),
                exportType: "general_ranking",
                championshipStats: generalStats,
                rankings: generalRanking.divisions,
                summary: {
                    totalDaysInChampionship: Object.keys(championship.days).length,
                    rankedDivisions: Object.keys(generalRanking.divisions).filter(div => 
                        generalRanking.divisions[div].length > 0
                    ).length
                }
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `classement_general_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Classement général exporté !', 'success');
        }
    </script>
</body>
</html>
